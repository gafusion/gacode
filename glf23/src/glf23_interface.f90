!-------------------------------------------------------------------------
! glf23_interface.f90
!
! PURPOSE:
!  Provides interface description for GLF23.
!
! CALLING SEQUENCE:
!  call glf23_init(...)
!  set glf23_*_in variables
!  call glf23_run(...)
!  get glf23_*_out variables
!
! NOTES:
!  glf23_path:        working directory 
!  glf23_dump_flag:   TRUE = call dump routines, FALSE = do NOT call dump routines
!  glf23_dump_suffix: appended to name of dump file
!
!  glf23_dump_local and glf23_dump_global are called by glf23_run
!
! NAMING CONVENTION:
!  Interface parameter names are formed from GLF23 variable names by 
!  prepending 'glf23_' and appending '_in'
!
! INITIALIZATION:
!  We initialize input arrays/vectors to zero 
!
!-------------------------------------------------------------------------

module glf23_interface

  implicit none
! maximum dimensions
  integer,parameter :: nsm=6
  integer,parameter :: maxmodes=4

  ! CONTROL PARAMETERS
  character (len=256)  :: glf23_path_in        = ''
  logical              :: glf23_dump_flag_in   = .false.
  logical              :: glf23_quiet_flag_in  = .true.

  ! INPUT PARAMETERS

  !  Data passed to: put_model_parameters
  logical :: glf23_use_transport_model_in = .true.
  logical :: glf23_use_adiabatic_electrons_in = .false.
  real    :: glf23_alpha_p_mult_in        = 1.0
  real    :: glf23_alpha_quench_mult_in   = 1.0
  integer :: glf23_version_in = 2
  integer :: glf23_lprint_in = 0

  ! Data passed to: put_species
  integer :: glf23_ns_in             = 2
  real    :: glf23_mass_in(nsm)      = 0.0
  real    :: glf23_zs_in(nsm)        = 0.0

  ! Data passed to: put_kys
  real    :: glf23_ky_in             = 0.3

  ! Data passed to: put_gradients
  real    :: glf23_rlns_in(nsm)      = 0.0
  real    :: glf23_rlts_in(nsm)      = 0.0
  real    :: glf23_vpar_shear_in(nsm)= 0.0
  real    :: glf23_vexb_shear_in     = 0.0

  ! Data passed to: put_averages
  real    :: glf23_taus_in(nsm)    = 0.0
  real    :: glf23_as_in(nsm)      = 0.0
  real    :: glf23_betae_in        = 0.0
  real    :: glf23_xnue_in         = 0.0

  ! Data passed to: put_s_alpha_geometry
  real    :: glf23_rmin_sa_in        = 0.5
  real    :: glf23_rmaj_sa_in        = 3.0
  real    :: glf23_q_sa_in           = 2.0
  real    :: glf23_shat_sa_in        = 1.0
  real    :: glf23_alpha_sa_in       = 0.0
  real    :: glf23_xwell_sa_in       = 0.0
  real    :: glf23_theta0_sa_in      = 0.0


  ! TRANSPORT OUTPUT PARAMETERS
  real :: glf23_elec_pflux_out = 0.0
  real :: glf23_elec_eflux_out = 0.0
  real :: glf23_elec_eflux_low_out = 0.0
  real :: glf23_elec_mflux_out = 0.0
  real :: glf23_elec_expwd_out = 0.0

  real, dimension(nsm-1) :: glf23_ion_pflux_out = 0.0
  real, dimension(nsm-1) :: glf23_ion_eflux_out = 0.0
  real, dimension(nsm-1) :: glf23_ion_eflux_low_out = 0.0
  real, dimension(nsm-1) :: glf23_ion_mflux_out = 0.0
  real, dimension(nsm-1) :: glf23_ion_expwd_out = 0.0
  
  ! LINEAR OUTPUT PARAMETERS
  complex :: glf23_eigenvalue_out(maxmodes)
  REAL,EXTERNAL :: get_growthrate
  REAL,EXTERNAL :: get_frequency
  REAL,EXTERNAL :: get_particle_flux
  REAL,EXTERNAL :: get_energy_flux
  REAL,EXTERNAL :: get_stress_tor
  REAL,EXTERNAL :: get_stress_par
  REAL,EXTERNAL :: get_exchange
  
  ! ERROR OUTPUT
  character (len=80) :: glf23_error_message='null'
  integer :: glf23_error_status=0

contains

  ! Dump LOCAL INTERFACE variables
  subroutine glf23_dump_local()

    implicit none

    integer :: ierr, i

    open(unit=1,file=trim(glf23_path_in)//'out.glf23.localdump',&
         status='replace',iostat=ierr)

    write(1,*) '# input.glf23 generated by glf23_dump_local()'
    write(1,*) '#'
    write(1,*) '# See https://fusion.gat.com/theory/glf23input'
    write(1,*) ' '
    write(1,*) '#---------------------------------------------------'
    write(1,*) '# Control parameters:'
    write(1,*) '#---------------------------------------------------'
    write(1,10) 'USE_TRANSPORT_MODEL',glf23_use_transport_model_in
    write(1,10) 'USE_ADIABATIC_ELECTRONS',glf23_use_adiabatic_electrons_in
    write(1,30) 'ALPHA_P_MULT',glf23_alpha_p_mult_in
    write(1,30) 'ALPHA_QUENCH_MULT',glf23_alpha_quench_mult_in
    write(1,20) 'VERSION',glf23_version_in
    write(1,20) 'LPRINT',glf23_lprint_in
!
    write(1,30) 'KY',glf23_ky_in
    write(1,30) 'VEXB_SHEAR',glf23_vexb_shear_in
    write(1,30) 'BETAE',glf23_betae_in
    write(1,30) 'XNUE',glf23_xnue_in
    write(1,*) ' '
    write(1,*) '#---------------------------------------------------'
    write(1,*) '# Species vectors:'
    write(1,*) '#---------------------------------------------------'
    write(1,20) 'NS',glf23_ns_in
    do i = 1,glf23_ns_in
        write(1,40) 'ZS_',i,glf23_zs_in(i)
    enddo
    do i = 1,glf23_ns_in
        write(1,40) 'MASS_',i,glf23_mass_in(i)
    enddo
    do i = 1,glf23_ns_in
        write(1,40) 'RLNS_',i,glf23_rlns_in(i)
    enddo
    do i = 1,glf23_ns_in
        write(1,40) 'RLTS_',i,glf23_rlts_in(i)
    enddo
    do i = 1,glf23_ns_in
        write(1,40) 'TAUS_',i,glf23_taus_in(i)
    enddo
    do i = 1,glf23_ns_in
        write(1,40) 'AS_',i,glf23_as_in(i)
    enddo
    do i = 1,glf23_ns_in
        write(1,40) 'VPAR_SHEAR_',i,glf23_vpar_shear_in(i)
    enddo
    write(1,*) ' '
    write(1,*) '#---------------------------------------------------'
    write(1,*) '# s-alpha geometry parameters:'
    write(1,*) '#---------------------------------------------------'
    write(1,30) 'RMIN_SA',glf23_rmin_sa_in
    write(1,30) 'RMAJ_SA',glf23_rmaj_sa_in
    write(1,30) 'Q_SA',glf23_q_sa_in
    write(1,30) 'SHAT_SA',glf23_shat_sa_in
    write(1,30) 'ALPHA_SA',glf23_alpha_sa_in
    write(1,30) 'XWELL_SA',glf23_xwell_sa_in
    write(1,30) 'THETA0_SA',glf23_theta0_sa_in
    write(1,*) ' '

    close(1)

10  format(t2,a,'=',l1)
20  format(t2,a,'=',i3)
30  format(t2,a,'=',1pe12.5)
40  format(t2,a,i1,'=',1pe12.5)

  end subroutine glf23_dump_local

  ! Dump GLF23 MODULE variables
  subroutine glf23_dump_module()

    use glf23_gf

    implicit none

    integer :: ierr

    open(unit=1,file=trim(glf23_path_in)//'out.glf23.moduledump',&
         status='replace',iostat=ierr)

    write(1,*) 'use_transport_model_gf = ', use_transport_model_gf
    write(1,*) 'use_adaibatic_electrons_gf = ',use_adiabatic_electrons_gf
    write(1,*) 'alpha_p_mult_gf = ',alpha_p_mult_gf
    write(1,*) 'alpha_e_mult_gf = ',alpha_e_mult_gf
    write(1,*) 'version_gf = ',version_gf
    write(1,*) 'lprint_gf = ',lprint_gf
    write(1,*) 'nroot_gf = ', nroot_gf
    write(1,*) 'ky_gf = ', xky0_gf
    write(1,*) 'ns_gf = ', ns_gf
    write(1,*) 'park_gf = ', park_gf
    write(1,*) 'ghat_gf = ', ghat_gf
    write(1,*) 'gchat_gf = ', gchat_gf
    write(1,*) 'alpha_e_gf = ', alpha_e_gf
    write(1,*) 'alpha_p_gf = ', alpha_p_gf
    write(1,*) 'betae_gf = ', betae_gf
    write(1,*) 'xnu_gf = ', xnu_gf

    write(1,*) 'amassgas_gf =', amassgas_gf
    write(1,*) 'amassimp_gf = ', amassimp_gf
    write(1,*) 'zimp_gf = ', zimp_gf
    write(1,*) 'rlne_gf = ', rlne_gf
    write(1,*) 'rlte_gf = ', rlte_gf
    write(1,*) 'rlni_gf = ', rlni_gf
    write(1,*) 'rlti_gf = ', rlti_gf
    write(1,*) 'rlnimp_gf = ',rlnimp_gf
    write(1,*) 'dil_gf = ',dil_gf
    write(1,*) 'gamma_p_gf = ', gamma_p_gf
    write(1,*) 'gamma_e_gf = ', gamma_e_gf
    write(1,*) 'awt_gf = ', apwt_gf
    write(1,*) 'aiwt_gf = ',aiwt_gf
    write(1,*) 'taui_gf = ', taui_gf

    write(1,*) 'rmin_gf = ', rmin_gf
    write(1,*) 'rmaj_gf = ', rmaj_gf
    write(1,*) 'q_gf = ', q_gf
    write(1,*) 'shat_gf = ', shat_gf
    write(1,*) 'alpha_gf = ', alpha_gf
    write(1,*) 'xwell_gf = ', xwell_gf
    write(1,*) 'theta0_gf = ', theta0_gf

    close(1)

  end subroutine glf23_dump_module

end module glf23_interface
