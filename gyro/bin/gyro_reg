#!/usr/bin/env python

#-------------------------------------------------
# SCRIPT:
#  gyro_reg
#
# FUNCTION:
#  Perform regression comparison.  That is, test 
#  data against known solution.
#--------------------------------------------------

import sys
import os
import string

#--------------------------------------------------
# Error tolerance
tol = 1e-4
#--------------------------------------------------

#--------------------------------------------------
n=len(sys.argv)

if n == 1:
    print "Usage: gyro_reg <testdir>"
    print 
    print "       Note that <testdir> must one of the entries"
    print "       listed by gyro -g" 
    sys.exit(0)
#--------------------------------------------------

path=os.environ.get('GACODE_ROOT')+'/gyro'
check1=sys.argv[1]+'/prec.out'
regress=sys.argv[1]+'/regress'

if n == 3: 
    simpath=sys.argv[2]+'/'
else:
    simpath='./'


#--------------------------------------------------
# Known data
#
if os.path.isfile(path+'/tools/input/'+check1) == 0:
	print "Regression data does not exist for "+sys.argv[1]
	sys.exit(0)

# Get regression text string
for line in open(path+'/tools/input/'+regress,'r').readlines():
    regtext = string.strip(line)

# Get correct checksum from prec.out:
for line in open(path+'/tools/input/'+check1,'r').readlines():
    line = string.strip(line)

data = string.splitfields(line,' ')
x1=eval(data[0])
#--------------------------------------------------

#--------------------------------------------------
# Data in question
#
for line in open(simpath+check1,'r').readlines():
    line = string.strip(line)

data = string.splitfields(line,' ')
if data[0] == "GKEIGEN":
   y1=data[0]
else:
   y1=eval(data[0])

#--------------------------------------------------

#--------------------------------------------------
# Perform comparison
#
# Test 1:

p = 0

if x1 == 0.0: 
   if y1 == 0.0:
      print sys.argv[1]+": PASS  "+regtext
      p = p+1
   else:
      print sys.argv[1]+": FAIL  "+regtext


else:

   if y1 == "GKEIGEN":
      print sys.argv[1]+": GKEIGEN not supported on this platform, no test performed."

   else:
      z=abs((x1-y1))/x1

      if z < tol:
         print sys.argv[1]+": PASS  "+regtext
         p = p+1
      else:
         print sys.argv[1]+": FAIL  "+regtext
#--------------------------------------------------



