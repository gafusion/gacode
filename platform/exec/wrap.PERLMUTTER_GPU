#! /usr/bin/env bash
# GACODE Parallel execution script (PERLMUTTER_GPU)

export MPICH_GPU_SUPPORT_ENABLED=1 

#env 1>&2

# TBD: Improve GPU selection based on CPU affinity
#echo $SLURM_LOCALID
let r4=SLURM_LOCALID/4
let l4="$SLURM_LOCALID-($r4*4)"
# GPU3 is connected to CPU0
let ACC_DEVICE_NUM=3-${l4}
export ACC_DEVICE_NUM

echo "`uname -n` $SLURM_LOCALID $ACC_DEVICE_NUM `taskset -pc $$`"
#ecno "uname -n` $SLURM_LOCALID LL $LD_LIBRARY_PATH"
exec  "$@"
