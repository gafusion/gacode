#!/bin/bash
#=============================================================
# gacode_mrun
#
# PURPOSE:
#  multirun tool
#=============================================================

#=============================================================
# Syntax validity check and help message
#
n=$#

if [ $n -eq 0 ]
then
  echo
  echo "Usage:   gacode_mrun [options]"
  echo
  echo "         -p <path>"
  echo "         Set optional path to simulation directory."
  echo "         The default path is \$PWD"
  echo
  echo "TEST MODE"
  echo
  echo "         -t <simdir>"  
  echo "         Sanity test."
  echo
  echo "EXECUTE MODE (single core)"
  echo
  echo "         -e <simdir>" 
  echo "         Run using input.<code> in <simdir>."
  echo
  echo "PLOT MODE"
  echo
  echo "         -plot" 
  echo "         Plot using data in CURRENT DIRECTORY"
  echo 
  echo "         -index <index>"
  echo "         Plot index."
  echo          
  echo "         For neo: see https://fusion.gat.com/theory/Neooutput#out.neo.transport"
  echo "         i.e., 1=r/a,6=G1,7=Q1,14=G2,15=Q2"
  echo
  echo "         For tglf:" 
  echo "         1=Ge,2=Qe,4=Pie,5=Se,6=Gi1,7=Qi1,9=Pi1,10=Si1"
  echo
  echo "PARAMETERS"
  echo
  echo "         -code <code>"
  echo "         Code (neo,tglf) to use (execute and plot modes)"
  echo
  echo "         -x <var1,var2>"
  echo "         Variable to scan (execute and plot modes)"
  echo
  echo "         -min <min1,min2>"
  echo "         Scan range in execute mode"
  echo
  echo "         -max <max1,max2>"
  echo "         Scan range in execute mode"
  echo
  echo "         -n <n1,n2>"
  echo "         Scan points in execute mode"

  exit 1
fi
#=============================================================
 
#=============================================================
# Define variables for flag capture
#
SIMROOT=$PWD
# Default number of cores
NPROC=1
# Execute/test mode flags
EXEC_FLAG=0
PLOT_FLAG=0
INDEX=1
CODE=neo
#=============================================================

#=============================================================
# Parse command line options
#
while [ $# -gt 0 ] ; do
  case "$1" in

  -p) shift ; SIMROOT=$1 ;;

  -e) shift ; LOCDIR=$1 ; EXEC_FLAG=1 ;;

  -t) shift ; LOCDIR=$1 ; EXEC_FLAG=0 ;;

  -x) shift ; X=$1 ;;
  -min) shift ; MIN=$1 ;;
  -max) shift ; MAX=$1 ;;
  -n) shift ; N=$1 ;;
  -plot) PLOT_FLAG=1 ;;
  -index) shift ; INDEX=$1 ;;
  -code) shift ; CODE=$1 ;;

  *) echo "ERROR: incorrect neo_mrun syntax." ; exit 1 ;;
 
  esac
  shift
done
#=============================================================

if [ "$LOCDIR" == "." ]
then
   SIMDIR=$PWD
   cd .. ; LOCDIR=$PWD
else
   SIMDIR=$SIMROOT/$LOCDIR
fi

#===========================================================
# Run python script

if [ "$CODE" == 'neo' ]
then
   EXEC=neo_mrun.py
else
   EXEC=tglf_mrun.py
fi


if [ $PLOT_FLAG -eq 0 ]
then
    python $GACODE_ROOT/shared/python/varscan/${EXEC} $X $MIN $MAX $N $EXEC_FLAG $SIMDIR
else
    python $GACODE_ROOT/shared/python/varscan/mrun_contour.py $SIMDIR $INDEX screen $CODE $X
fi

#===========================================================
