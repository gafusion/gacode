#!/bin/bash
# Klaus Hallatschek 2024
#fordep <module> <stem of src>
#e.g. fordep timer_lib cgyro_timer_lib -> use timer_lib  // cgyro_timer_lib.o timer_lib.mod

fordep1 () {
a=$1
c=$2
c=${c:=$a}
b=$(grep -iE ^[[:space:]]*use[[:space:]]\*$a *.?90|sed "s/\..*/.o/"|sort|uniq)
if [[ $b ]] ; then
   echo $b: $c.o
   fi
}

#determine all module files in directory of fortran sources and output dependencies for gmake
echo \# all module induced dependencies in directory $(realpath --relative-to=$GACODE_ROOT .)
echo
for i in *90 ; do
    ms=$(sed -nE "/^[[:space:]]*(module|MODULE|Module)/s/.*(module|MODULE|Module)[[:space:]]*//p" <$i)
    for m in $ms ; do
    	  echo \# module $m in $i
	  fordep1 $m ${i%.[fF]90}
	  echo
	done
    done
